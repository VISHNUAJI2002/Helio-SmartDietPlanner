{% extends "base.html" %}
{% block content %}
<style>
    body {
        background-color: #f8f9fa; /* Light grey background */
    }

    .profile-container {
        max-width: 1250px;
        margin: auto;
    }

    /* General Card Styling */
    .info-card {
        background-color: #fff;
        border-radius: 12px; /* Smoother corners */
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
        padding: 30px;
        margin-bottom: 25px;
        border: none; /* Remove default border */
    }

    .info-card h3 {
        color: #343a40; /* Darker text for titles */
        font-weight: 600; /* Bold, but not overly heavy */
        margin-bottom: 25px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e9ecef;
        font-size: 1.5rem; /* Consistent title size */
    }
    
    /* Main Welcome Header */
    .welcome-header h2 {
        font-weight: 600;
        color: #212529;
    }
    .welcome-header p {
        color: #6c757d;
        font-size: 1.1rem;
    }

    /* Health Metrics & Details Styling */
    .metric-item {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        font-size: 1rem; /* Standard body font size */
    }
    .metric-item strong {
        color: #343a40;
        width: 170px; /* Adjusted for alignment */
    }
    .metric-item span {
        color: #6c757d;
        font-weight: 500;
    }

    /* Profile Completion Bar styles */
    .progress-bar {
        height: 12px;
        border-radius: 10px;
        transition: width 0.4s ease-in-out;
    }
    .progress-label {
        font-weight: 500;
        color: #495057;
        font-size: 0.9rem;
    }

</style>

<div class="container profile-container mt-4">
    
    {% if profile and profile.age %}

    <div class="welcome-header mb-4">
        <h2>Health Profile</h2>
        <p>Hereâ€™s a summary of your current health status and details.</p>
    </div>

    <div class="row">
        <!-- --- LEFT CARD: PERSONAL & HEALTH DETAILS --- -->
        <div class="col-lg-7">
            <div class="info-card">
                <h3>Your Information</h3>
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-item"><strong>Age:</strong> <span>{{ profile.age }}</span></div>
                        <div class="metric-item"><strong>Gender:</strong> <span>{% if profile.gender == "0" %}Male{%
                                else %}Female{% endif %}</span></div>                        
                        <div class="metric-item"><strong>Height (cm):</strong> <span>{{ profile.height_cm }}</span>
                        </div>
                        <div class="metric-item"><strong>Weight (kg):</strong> <span>{{ profile.weight_kg }}</span>
                        </div>
                        <div class="metric-item"><strong>BMI:</strong> <span>{{ "%.1f"|format(profile.bmi|float)
                                }}</span></div>   
                        <div class="metric-item"><strong>Chronic Disease:</strong> <span>{% if profile.chronic_disease
                                == "1" %}Yes{% else %}No{% endif %}</span></div>                                                     

                    </div>
                    <div class="col-md-6">
                        <div class="metric-item"><strong>BP Systolic:</strong> <span>{{ profile.blood_pressure_systolic
                                }}</span></div>                        
                        <div class="metric-item"><strong>BP Diastolic:</strong> <span>{{
                                profile.blood_pressure_diastolic }}</span></div>
                        <div class="metric-item"><strong>Cholesterol Level:</strong> <span>{{ profile.cholesterol_level
                                }}</span></div>                                
                        <div class="metric-item"><strong>Blood Sugar Level:</strong> <span>{{ profile.blood_sugar_level
                                }}</span></div>
                        <div class="metric-item"><strong>Sleep Hours:</strong> <span>{{ profile.sleep_hours }}</span>
                        </div>                                
                        <div class="metric-item"><strong>Dietary Preference:</strong> <span>{% if profile.dietary_preference == 'veg' %}Vegetarian
                            {% elif profile.dietary_preference == 'non-veg' %}Non-Vegetarian{% else %}Any{% endif %}</span></div>        
                    </div>
                </div>

                <!-- --- PROFILE COMPLETION BAR (LOGIC FIXED) --- -->
                <div class="mt-4 pt-3 border-top">
                    {% set fields = ['age', 'gender', 'height_cm', 'weight_kg', 'chronic_disease',
                    'blood_pressure_systolic', 'blood_pressure_diastolic', 'cholesterol_level', 'blood_sugar_level',
                    'sleep_hours'] %}
                    
                    {% set count = {'value': 0} %}
                    {% for field in fields %}
                        {% if profile.get(field) is not none and profile.get(field)|string|trim != '' %}
                            {% if count.update({'value': count.value + 1}) %}{% endif %}
                        {% endif %}
                    {% endfor %}
                    {% set completed_count = count.value %}
                    
                    {% set completion_percentage = (completed_count / fields|length * 100)|int %}

                    {% set progress_color = 'bg-danger' %}
                    {% if completion_percentage >= 90 %}
                        {% set progress_color = 'bg-success' %}
                    {% elif completion_percentage >= 50 %}
                        {% set progress_color = 'bg-warning' %}
                    {% endif %}

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0 text-secondary" style="font-size: 0.9rem;">Profile Completion</h6>
                        <span class="progress-label">{{ completion_percentage }}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar {{ progress_color }}" role="progressbar"
                            style="width: {{ completion_percentage }}%;" aria-valuenow="{{ completion_percentage }}"
                            aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <!-- --- END FIX --- -->

            </div>
        </div>

        <!-- --- RIGHT CARD: QUICK ACTIONS --- -->
        <div class="col-lg-5">
            <div class="info-card">
                <h3>Quick Actions</h3>
                <p class="text-muted">Need to make changes or head back to your main dashboard?</p>
                <div class="d-flex flex-wrap gap-2 mt-3">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#updateProfileModal"><i class="bi bi-pencil-fill"></i>
                        Update Profile</button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-success"> <i class="bi bi-speedometer2"></i> Dashboard</a>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- New User Form -->
    <div class="info-card">
        <h3 class="mb-3 text-primary text-start">Complete Your Profile</h3>
        <p class="text-muted">Please enter your details to get personalized diet recommendations.</p>
        <form method="POST" class="row g-3" id="initial-profile-form">
            <div class="col-md-6">
                <label class="form-label">Age</label>
                <input type="number" name="age" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Gender</label>
                <select name="gender" class="form-select" required>
                    <option value="0">Male</option>
                    <option value="1">Female</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Height (cm)</label>
                <input type="number" name="height_cm" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Weight (kg)</label>
                <input type="number" name="weight_kg" class="form-control" required>
            </div>
            <!-- START OF NEW CODE: Dietary Preference for New User -->
            <div class="col-md-6">
                <label class="form-label">Dietary Preference</label>
                <select name="dietary_preference" class="form-select">
                    <option value="veg">Vegetarian</option>
                    <option value="non-veg">Non-Vegetarian</option>
                    <option value="both" selected>Any</option>
                </select>
            </div>
            <!-- END OF NEW CODE -->
            <div class="col-md-6">
                <label class="form-label">Chronic Disease</label>
                <select name="chronic_disease" class="form-select">
                    <option value="0" selected>No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">BP Systolic</label>
                <input type="number" name="blood_pressure_systolic" class="form-control" placeholder="Optional, e.g., 120">
            </div>
            <div class="col-md-6">
                <label class="form-label">BP Diastolic</label>
                <input type="number" name="blood_pressure_diastolic" class="form-control" placeholder="Optional, e.g., 80">
            </div>
            <div class="col-md-6">
                <label class="form-label">Cholesterol (mg/dL)</label>
                <input type="number" name="cholesterol_level" class="form-control" placeholder="Optional, e.g., 200">
            </div>
            <div class="col-md-6">
                <label class="form-label">Blood Sugar (mg/dL)</label>
                <input type="number" name="blood_sugar_level" class="form-control" placeholder="Optional, e.g., 100">
            </div>
            <div class="col-md-6">
                <label class="form-label">Sleep Hours</label>
                <input type="number" name="sleep_hours" class="form-control" placeholder="Optional, e.g., 7">
            </div>
            <div class="col-12 d-grid">
                <button type="submit" class="btn btn-success btn-lg">Save Profile</button>
            </div>
        </form>
    </div>
    {% endif %}
</div>

<!-- Update Profile Modal -->
<div class="modal fade" id="updateProfileModal" tabindex="-1" aria-labelledby="updateProfileLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content p-4" style="border: none;">
            <div class="modal-header border-0">
                <h5 class="modal-title text-success text-start" id="updateProfileLabel">Update Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" class="row g-3" id="update-profile-form">
                   <div class="col-md-6">
                        <label class="form-label">Age</label>
                        <input type="number" name="age" class="form-control" value="{{ profile.age }}" 
                        min="5" max="120" 
                        title="Please enter an age between 5 and 120." 
                        placeholder="e.g., 25" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Gender</label>
                        <select name="gender" class="form-select" required>
                            <option value="0" {% if profile.gender=="0" %}selected{% endif %}>Male</option>
                            <option value="1" {% if profile.gender=="1" %}selected{% endif %}>Female</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Height (cm)</label>
                        <input type="number" name="height_cm" class="form-control" value="{{ profile.height_cm }}"
                        min="40" max="300" title="Entered height is out of range" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" name="weight_kg" class="form-control" value="{{ profile.weight_kg }}"
                        min="10" max="700" title="Entered weight is out of range" required>
                    </div>
                     <!-- START OF NEW CODE: Dietary Preference for Update Modal -->
                    <div class="col-md-6">
                        <label class="form-label">Dietary Preference</label>
                        <select name="dietary_preference" class="form-select">
                            <option value="veg" {% if profile.dietary_preference == 'veg' %}selected{% endif %}>Vegetarian</option>
                            <option value="non-veg" {% if profile.dietary_preference == 'non-veg' %}selected{% endif %}>Non-Vegetarian</option>
                            <option value="both" {% if profile.dietary_preference == 'both' or not profile.dietary_preference %}selected{% endif %}>Any</option>
                        </select>
                    </div>
                    <!-- END OF NEW CODE -->
                    <div class="col-md-6">
                        <label class="form-label">Chronic Disease</label>
                        <select name="chronic_disease" class="form-select">
                            <option value="0" {% if profile.chronic_disease=="0" %}selected{% endif %}>No</option>
                            <option value="1" {% if profile.chronic_disease=="1" %}selected{% endif %}>Yes</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">BP Systolic</label>
                        <input type="number" name="blood_pressure_systolic" class="form-control"
                            value="{{ profile.blood_pressure_systolic }}" placeholder="Optional, e.g., 120"
                            min="80" max="370" title="Entered BP Systolic value is out of range" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">BP Diastolic</label>
                        <input type="number" name="blood_pressure_diastolic" class="form-control"
                            value="{{ profile.blood_pressure_diastolic }}" placeholder="Optional, e.g., 80"
                            min="50" max="360" title="Entered BP Diastolic value is out of range" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Cholesterol (mg/dL)</label>
                        <input type="number" name="cholesterol_level" class="form-control"
                            value="{{ profile.cholesterol_level }}" placeholder="Optional, e.g., 200"
                            min="50" max="800" title="Entered cholestrol value is out of range" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Blood Sugar (mg/dL)</label>
                        <input type="number" name="blood_sugar_level" class="form-control"
                            value="{{ profile.blood_sugar_level }}" placeholder="Optional, e.g., 100"
                            min="10" max="2656" title="Entered Blood sugar value is out of range" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sleep Hours</label>
                        <input type="number" name="sleep_hours" class="form-control" value="{{ profile.sleep_hours }}" placeholder="Optional, e.g., 7"
                        min="0" max="24" title="please enter a valid number" required>
                    </div>
                    <div class="col-12 d-grid">
                        <button type="submit" class="btn btn-success btn-lg">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-warning" id="warningModalLabel"><i class="bi bi-exclamation-triangle-fill"></i> Incomplete Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        You have left some optional health fields blank. For the most accurate predictions, we recommend filling out all details.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Go Back & Edit</button>
        <button type="button" class="btn btn-primary" id="confirm-continue-btn">Continue Anyway</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    let formToSubmit = null;
    const warningModal = new bootstrap.Modal(document.getElementById('warningModal'));
    const confirmContinueBtn = document.getElementById('confirm-continue-btn');

    function checkOptionalFields(form) {
        const optionalFields = ['blood_pressure_systolic', 'blood_pressure_diastolic', 'cholesterol_level', 'blood_sugar_level', 'sleep_hours'];
        let hasEmptyFields = false;
        optionalFields.forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (field && field.value.trim() === '') {
                hasEmptyFields = true;
            }
        });
        return hasEmptyFields;
    }

    function formSubmitHandler(event) {
        if (checkOptionalFields(event.target)) {
            event.preventDefault(); 
            formToSubmit = event.target; 
            warningModal.show(); 
        }
    }

    const updateForm = document.getElementById('update-profile-form');
    if (updateForm) {
        updateForm.addEventListener('submit', formSubmitHandler);
    }

    const initialForm = document.getElementById('initial-profile-form');
    if (initialForm) {
        initialForm.addEventListener('submit', formSubmitHandler);
    }
    
    confirmContinueBtn.addEventListener('click', function() {
        if (formToSubmit) {
            formToSubmit.submit();
        }
    });
});
</script>

{% endblock %}

